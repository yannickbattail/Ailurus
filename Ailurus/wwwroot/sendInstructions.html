<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body style="background-color: ghostwhite">
    <canvas id="canvas" width="100" height="100"></canvas>
    <div id="lastUpdate">
        Last update:
    </div>
    <div id="stats">
        
    </div>
    <br />
    Drone: <select id="Drone">
        <option>Drone_1</option>
        <option>Drone_2</option>
    </select>
    <br /> 
    Action: <select id="TYPE">
        <option value="Collect">Collect</option>
        <option value="Unload">Unload</option>
        <option value="MoveTo">Move to</option>
    </select>
    <br />
    <select id="Destination">
        <option value="2,2">Home</option>
        <option value="98,98">Gold Mine</option>
    </select>
    <br />
    <input type="button" value="Do it!" onclick="doIt()" />
    <br />
    <div id="out">
		
    </div>
</body>
<script>
    function doIt() {
        var instruction = {};
        instruction['TYPE'] = $('#TYPE').val();
        instruction['DroneName'] = $('#Drone').val();
        if (instruction['TYPE'] === 'MoveTo') {
            var destination = $('#Destination').val().split(',', 2);
            instruction['Destination'] = {"X":destination[0], "Y":destination[1]};
        } else {
            instruction['Destination'] = null;
        }

        var data = [instruction];
        apiInstructions(data, function (response) {
            $('#Drone').html(response);
        });
    }

    function apiInstructions(instructions, success){
        $.ajax({
            "type": "POST",
            "url": URL_PREFIX + "instructions",
            "data": JSON.stringify(instructions),
            "contentType": 'application/json',
            "dataType": 'json',
            "success": function (result) {
                var out = $("#out");
                out.html(result);
            }
        });
    }

    function apiPlayerContext(success){
        $.ajax({
            "type": "GET",
            "url": URL_PREFIX + "playerContext",
            "contentType": 'application/json',
            "dataType": 'json',
            "success": success
        });
    }
    
    function apiMap(success){
        $.ajax({
            "type": "GET",
            "url": URL_PREFIX + "map",
            "contentType": 'application/json',
            "dataType": 'json',
            "success": success
        });
    }

    function inLoop() {
        apiPlayerContext(function (response) {
            console.log(response);
            playerContext = response;
            clear();
            drawMainBuilding(map.items[0].position);
            drawMine(map.items[1].position);
            drawDrone(playerContext.drones[0].currentPosition);
            drawDrone(playerContext.drones[1].currentPosition);
            statsDrones(playerContext.drones);
            $('#lastUpdate').html('Last update: ' + new Date().getTime());
            setTimeout(inLoop, repeat);
        });

    }

    function formatnum(num){
        return Math.round(num*10)/10;
    }

    function formatCoord(coord){
        if (coord == null) {
            return ' - ';
        }
        return coord.x+';'+coord.y;
    }
    
    function formatStrorage(st){
        if (st == null) {
            return ' - ';
        }
        return st.quantity+' '+st.resource ;
    }
    
    function formatDate(d){
        if (d == null) {
            return ' - ';
        }
        var date = new Date(d);
        return date.getHours()+':'+date.getMinutes()+':'+date.getSeconds();
    }
    
    function formatProgress(num){
        var s =  Math.round(num*100);
        return '<div style="width:100px; background-color: white">' +
            '<div style="width:'+s+'px; background-color: blue">'+s+' %</div>' +
            '</div>';
    }
    
    function statsDrones(drones){
        var html = "<table>";
        html += "<tr>";
        html += "   <td>Name<td>";
        html += "   <td>Position<td>";
        html += "   <td>Speed<td>";
        html += "   <td>State<td>";
        html += "   <td>Storage size<td>";
        html += "   <td>Storage<td>";
        html += "   <td>lastInstruction<td>";
        html += "   <td>progression<td>";
        html += "   <td>destination<td>";
        html += "   <td>distance<td>";
        html += "   <td>duration<td>";
        html += "   <td>startedAt<td>";
        html += "   <td>endAt<td>";
        html += "   <td>abortedAt<td>";
        html += "</td>";
        html += "</tr>";
        for (var droneIndex = 0; droneIndex < drones.length; droneIndex++) {
            var drone = drones[droneIndex];
            html += "<tr>";
            html += "   <td>"+drone.name+"<td>";
            html += "   <td>"+formatCoord(drone.currentPosition)+"<td>";
            html += "   <td>"+drone.speed+"<td>";
            html += "   <td>"+drone.state+"<td>";
            html += "   <td>"+drone.storageSize+"<td>";
            html += "   <td>"+formatStrorage(drone.storage)+"<td>";
            if (drone.lastInstruction !== null){
            html += "   <td>"+drone.lastInstruction.type+"<td>";
            html += "   <td>"+formatProgress(drone.lastInstruction.progression)+"<td>";
            html += "   <td>"+formatCoord(drone.lastInstruction.destination)+"<td>";
            html += "   <td>"+formatnum(drone.lastInstruction.distance)+"<td>";
            html += "   <td>"+formatnum(drone.lastInstruction.duration)+"<td>";
            html += "   <td>"+formatDate(drone.lastInstruction.startedAt)+"<td>";
            html += "   <td>"+formatDate(drone.lastInstruction.endAt)+"<td>";
            html += "   <td>"+formatDate(drone.lastInstruction.abortedAt)+"<td>";
            } else {
                html += "   <td> - <td>";
                html += "   <td> - <td>";
                html += "   <td> - <td>";
                html += "   <td> - <td>";
                html += "   <td> - <td>";
                html += "   <td> - <td>";
                html += "   <td> - <td>";
                html += "   <td> - <td>";
            }
            html += "</td>";
            html += "</tr>";
        }
        html += "</table>";
        
        $('#stats').html(html);
    }
    
    function clear() {
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, 100, 100);
    }

    function drawMainBuilding(coord){
        ctx.fillStyle = 'green';
        ctx.fillRect(coord.x, coord.y, 1, 1);
    }

    function drawMine(coord){
        ctx.fillStyle = 'red';
        ctx.fillRect(coord.x, coord.y, 1, 1);
    }

    function drawDrone(coord){
        ctx.fillStyle = 'blue';
        ctx.fillRect(coord.x, coord.y, 1, 1);
    }
    
    var URL_PREFIX = "http://localhost:61218/";

    var ctx = document.getElementById('canvas').getContext('2d');
    var repeat = 2000;
    var map = {};
    var playerContext = {};
    apiMap(function (response) {
        map = response;
        setTimeout(inLoop, repeat);
    });
    
</script>
</html>